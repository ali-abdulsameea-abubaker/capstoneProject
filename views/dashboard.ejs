
<style>
  /* Make remove buttons always visible */
  .remove-btn {
    border-width: 1px;
    padding: 0.25rem 0.5rem;
    transition: all 0.2s ease;
    position: relative;
    z-index: 1;
    background-color: #dc3545 !important;
    color: white !important;
    border-color: #dc3545 !important;
  }

  .remove-btn:hover {
    background-color: #bb2d3b !important;
    border-color: #b02a37 !important;
    transform: scale(1.05);
  }

  /* Edit button styles */
  .edit-btn {
    border-width: 1px;
    padding: 0.25rem 0.5rem;
    transition: all 0.2s ease;
    position: relative;
    z-index: 1;
  }

  .edit-btn:hover {
    transform: scale(1.05);
  }

  /* Ensure proper spacing for buttons */
  .flex-shrink-0 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    position: relative;
    z-index: 1;
  }

  /* Make sure list items don't block clicks */
  .list-group-item {
    position: relative;
    z-index: 0;
  }

  /* Make sure badges and buttons are properly aligned */
  .badge {
    padding: 0.35em 0.65em;
  }

  /* Edit form styles */
  .edit-form {
    display: none;
    margin-top: 10px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
  }

  .edit-field {
    margin-bottom: 10px;
  }
</style>

<%- include('partials/header', {title: 'Pet Dashboard' }) %>

<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h3 mb-1">Welcome, <%= username %>!</h1>
        <p class="text-muted mb-0">üêæ Here's your pet dashboard</p>
      </div>
      <div class="d-flex">
        <a href="/pets/add" class="btn btn-custom me-2">
          <i class="bi bi-plus-circle"></i> Add Pet
        </a>
        <a href="/schedule-task" class="btn btn-outline-custom">
          <i class="bi bi-plus-circle"></i> Add Task
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Stats Overview -->
<div class="row mb-4">
  <div class="col-md-4 mb-3">
    <div class="card card-custom h-100">
      <div class="card-body text-center">
        <div class="d-flex align-items-center justify-content-center">
          <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
            <i class="bi bi-heart-fill text-primary" style="font-size: 1.5rem;"></i>
          </div>
          <div>
            <h3 class="h2 mb-0">
              <%= pets ? pets.length : 0 %>
            </h3>
            <p class="text-muted mb-0">Pets</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="card card-custom h-100">
      <div class="card-body text-center">
        <div class="d-flex align-items-center justify-content-center">
          <div class="bg-warning bg-opacity-10 p-3 rounded-circle me-3">
            <i class="bi bi-list-check text-warning" style="font-size: 1.5rem;"></i>
          </div>
          <div>
            <h3 class="h2 mb-0">
              <%= tasks ? tasks.length : 0 %>
            </h3>
            <p class="text-muted mb-0">Tasks Due</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="card card-custom h-100">
      <div class="card-body text-center">
        <div class="d-flex align-items-center justify-content-center">
          <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3">
            <i class="bi bi-people-fill text-success" style="font-size: 1.5rem;"></i>
          </div>
          <div>
            <h3 class="h2 mb-0">1</h3>
            <p class="text-muted mb-0">Owner</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Pets Section -->
  <div class="col-lg-6 mb-4">
    <div class="card card-custom h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">Your Pets</h2>
        <a href="/pets/add" class="btn btn-sm btn-outline-custom">
          <i class="bi bi-plus"></i> Add
        </a>
      </div>
      <div class="card-body">
        <% if (pets && pets.length> 0) { %>
          <div class="list-group list-group-flush">
            <% pets.forEach(pet=> { %>
              <div class="list-group-item border-0 px-0 py-3">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0">
                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                      <i class="bi bi-heart-fill text-primary"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h5 class="mb-1">
                      <%= pet.name %>
                    </h5>
                    <p class="text-muted mb-0 small">
                      <%= pet.breed || 'Unknown breed' %> ‚Ä¢
                      <!-- Enhanced age display -->
                      <% if (pet.age !== null && pet.age !== undefined) { %>
                        <%
                          const ageValue = parseFloat(pet.age);
                          let ageDisplay;
                          
                          if (ageValue < 1) {
                            // Show months for values less than 1 year
                            const months = Math.round(ageValue * 12);
                            ageDisplay = months + ' month' + (months !== 1 ? 's' : '');
                          } else if (Number.isInteger(ageValue)) {
                            // Whole number - show without decimals
                            ageDisplay = ageValue + ' years';
                          } else {
                            // Decimal value 1 or greater - show with one decimal place
                            ageDisplay = ageValue.toFixed(1) + ' years';
                          }
                        %>
                        <span id="age-display-<%= pet.pet_id %>"><%= ageDisplay %></span>
                      <% } else { %>
                        <span id="age-display-<%= pet.pet_id %>">Age unknown</span>
                      <% } %> ‚Ä¢
                      <span id="weight-display-<%= pet.pet_id %>">
                        <%= pet.weight ? pet.weight + ' kg' : 'Weight unknown' %>
                      </span> ‚Ä¢
                      <%= pet.species || 'Unknown' %>
                    </p>

                    <!-- Edit Form (Hidden by default) -->
                    <div class="edit-form" id="edit-form-<%= pet.pet_id %>">
                      <h6 class="mb-2">Edit Pet Details</h6>
                      <div class="row">
                        <div class="col-md-6 edit-field">
                          <label for="edit-age-<%= pet.pet_id %>" class="form-label small">Age (years)</label>
                          <input type="number" class="form-control form-control-sm" 
                                 id="edit-age-<%= pet.pet_id %>" 
                                 value="<%= pet.age || '' %>" 
                                 min="0.1" step="0.1">
                        </div>
                        <div class="col-md-6 edit-field">
                          <label for="edit-weight-<%= pet.pet_id %>" class="form-label small">Weight (kg)</label>
                          <input type="number" class="form-control form-control-sm" 
                                 id="edit-weight-<%= pet.pet_id %>" 
                                 value="<%= pet.weight || '' %>" 
                                 min="0" step="0.1">
                        </div>
                      </div>
                      <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-sm btn-success save-edit-btn" 
                                data-pet-id="<%= pet.pet_id %>">
                          <i class="bi bi-check"></i> Save
                        </button>
                        <button class="btn btn-sm btn-secondary cancel-edit-btn" 
                                data-pet-id="<%= pet.pet_id %>">
                          <i class="bi bi-x"></i> Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="flex-shrink-0">
                    <span class="badge bg-light text-dark me-2">
                      <%= pet.gender || 'Unknown' %>
                    </span>
                    <!-- Edit Pet Button -->
                    <button class="btn btn-sm btn-outline-primary edit-btn me-2" 
                            data-pet-id="<%= pet.pet_id %>">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <!-- Remove Pet Button -->
                    <button class="btn btn-sm btn-outline-danger remove-btn" 
                            data-type="pet" data-id="<%= pet.pet_id %>" 
                            data-name="<%= pet.name %>">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="text-center py-4">
            <div class="bg-light rounded-circle p-4 d-inline-block mb-3">
              <i class="bi bi-heart text-muted" style="font-size: 2rem;"></i>
            </div>
            <h5 class="text-muted">No pets yet</h5>
            <p class="text-muted mb-3">Add your first pet to get started</p>
            <a href="/pets/add" class="btn btn-custom">Add Your First Pet</a>
          </div>
        <% } %>
      </div>
    </div>
  </div>
    <!-- Tasks Section -->
    <div class="col-lg-6 mb-4">
      <div class="card card-custom h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">Upcoming Tasks</h2>
          <a href="/schedule-task" class="btn btn-sm btn-outline-custom">
            <i class="bi bi-plus"></i> Add
          </a>
        </div>
        <div class="card-body">
          <% if (tasks && tasks.length> 0) { %>
            <div class="list-group list-group-flush">
              <% tasks.forEach(task=> { %>
                <div class="list-group-item border-0 px-0 py-3">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                      <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                        <i class="bi bi-list-check text-warning"></i>
                      </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                      <h5 class="mb-1">
                        <%= task.title %>
                      </h5>
                      <p class="text-muted mb-0 small">
                        For: <%= task.pet_name %> ‚Ä¢
                          Due: <%= new Date(task.due_date).toLocaleDateString() %>
                      </p>
                    </div>
                    <div class="flex-shrink-0">
                      <span
                        class="badge bg-<%= task.priority === 'high' ? 'danger' : task.priority === 'medium' ? 'warning' : 'info' %> me-2">
                        <%= task.priority %>
                      </span>
                      <!-- Remove Task Button -->
                      <button class="btn btn-sm btn-outline-danger remove-btn" data-type="task"
                        data-id="<%= task.task_id %>" data-name="<%= task.title %>">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <% }); %>
            </div>
            <% } else { %>
              <div class="text-center py-4">
                <div class="bg-light rounded-circle p-4 d-inline-block mb-3">
                  <i class="bi bi-list-check text-muted" style="font-size: 2rem;"></i>
                </div>
                <h5 class="text-muted">No upcoming tasks</h5>
                <p class="text-muted mb-3">Schedule your first task</p>
                <a href="/schedule-task" class="btn btn-custom">Schedule a Task</a>
              </div>
              <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row">
    <div class="col-12">
      <div class="card card-custom">
        <div class="card-header">
          <h2 class="h5 mb-0">Quick Actions</h2>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-sm-6 col-md-3 mb-3">
              <a href="/pets/add" class="btn btn-outline-custom w-100 d-flex flex-column align-items-center py-3">
                <i class="bi bi-plus-circle mb-2" style="font-size: 1.5rem;"></i>
                <span>Add Pet</span>
              </a>
            </div>
            <div class="col-sm-6 col-md-3 mb-3">
              <a href="/schedule-task" class="btn btn-outline-custom w-100 d-flex flex-column align-items-center py-3">
                <i class="bi bi-calendar-plus mb-2" style="font-size: 1.5rem;"></i>
                <span>Schedule Task</span>
              </a>
            </div>
            <div class="col-sm-6 col-md-3 mb-3">
              <a href="/health" class="btn btn-outline-custom w-100 d-flex flex-column align-items-center py-3">
                <i class="bi bi-heart-pulse mb-2" style="font-size: 1.5rem;"></i>
                <span>Health Tracker</span>
              </a>
            </div>
            <div class="col-sm-6 col-md-3 mb-3">
              <a href="/community" class="btn btn-outline-custom w-100 d-flex flex-column align-items-center py-3">
                <i class="bi bi-people mb-2" style="font-size: 1.5rem;"></i>
                <span>Community</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Removal</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="confirmationMessage">Are you sure you want to remove this item?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmRemoveBtn">Remove</button>
        </div>
      </div>
    </div>
  </div>


  <script src="/js/dashboard.js"></script>

  
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Edit button functionality
  document.querySelectorAll('.edit-btn').forEach(button => {
    button.addEventListener('click', function() {
      const petId = this.getAttribute('data-pet-id');
      const editForm = document.getElementById(`edit-form-${petId}`);
      
      // Hide all other edit forms
      document.querySelectorAll('.edit-form').forEach(form => {
        if (form.id !== `edit-form-${petId}`) {
          form.style.display = 'none';
        }
      });
      
      // Toggle current edit form
      if (editForm.style.display === 'block') {
        editForm.style.display = 'none';
      } else {
        editForm.style.display = 'block';
      }
    });
  });

  // Cancel edit button
  document.querySelectorAll('.cancel-edit-btn').forEach(button => {
    button.addEventListener('click', function() {
      const petId = this.getAttribute('data-pet-id');
      document.getElementById(`edit-form-${petId}`).style.display = 'none';
    });
  });

  // Save edit button
  document.querySelectorAll('.save-edit-btn').forEach(button => {
    button.addEventListener('click', function() {
      const petId = this.getAttribute('data-pet-id');
      const ageInput = document.getElementById(`edit-age-${petId}`);
      const weightInput = document.getElementById(`edit-weight-${petId}`);
      
      const newAge = parseFloat(ageInput.value);
      const newWeight = parseFloat(weightInput.value);
      
      // Validation
      if (isNaN(newAge) || newAge <= 0) {
        alert('Age must be greater than 0');
        return;
      }
      
      if (isNaN(newWeight) || newWeight < 0) {
        alert('Weight cannot be negative');
        return;
      }
      
      // Show loading state
      const originalText = this.innerHTML;
      this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
      this.disabled = true;
      
      // Send update request
      fetch(`/pets/${petId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          age: newAge,
          weight: newWeight
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          // Update display values
          let ageDisplay;
          if (newAge < 1) {
            const months = Math.round(newAge * 12);
            ageDisplay = months + ' month' + (months !== 1 ? 's' : '');
          } else if (Number.isInteger(newAge)) {
            ageDisplay = newAge + ' years';
          } else {
            ageDisplay = newAge.toFixed(1) + ' years';
          }
          
          document.getElementById(`age-display-${petId}`).textContent = ageDisplay;
          document.getElementById(`weight-display-${petId}`).textContent = newWeight + ' kg';
          
          // Hide edit form
          document.getElementById(`edit-form-${petId}`).style.display = 'none';
          
          // Show success message
          showAlert('Pet details updated successfully!', 'success');
        } else {
          alert('Error updating pet: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error updating pet details');
      })
      .finally(() => {
        // Restore button state
        this.innerHTML = originalText;
        this.disabled = false;
      });
    });
  });

  function showAlert(message, type) {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert-dashboard');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dashboard alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    alertDiv.innerHTML = `
      <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 5000);
  }
});
</script>

<%- include('partials/footer') %>



    <!-- Add Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">