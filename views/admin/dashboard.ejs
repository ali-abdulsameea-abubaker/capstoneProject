<%- include('../partials/header', {title: 'Admin Dashboard'}) %>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
      <div class="position-sticky pt-3">
        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>Admin Panel</span>
        </h6>
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" href="/admin/dashboard">
              <i class="bi bi-speedometer2 me-2"></i>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/users">
              <i class="bi bi-people me-2"></i>
              User Management
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/posts">
              <i class="bi bi-chat-dots me-2"></i>
              Post Moderation
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Admin Dashboard</h1>
      </div>

      <!-- Stats Cards -->
      <div class="row">
        <div class="col-md-3 mb-4">
          <div class="card text-white bg-primary">
            <div class="card-body">
              <h5 class="card-title"><%= userCount %></h5>
              <p class="card-text">Total Users</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-4">
          <div class="card text-white bg-success">
            <div class="card-body">
              <h5 class="card-title"><%= petCount %></h5>
              <p class="card-text">Total Pets</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-4">
          <div class="card text-white bg-warning">
            <div class="card-body">
              <h5 class="card-title"><%= taskCount %></h5>
              <p class="card-text">Total Tasks</p>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-4">
          <div class="card text-white bg-info">
            <div class="card-body">
              <h5 class="card-title"><%= postCount %></h5>
              <p class="card-text">Community Posts</p>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Recent Users -->
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title">Recent Users</h5>
            </div>
            <div class="card-body">
              <% if (recentUsers.length > 0) { %>
                <div class="list-group">
                  <% recentUsers.forEach(user => { %>
                    <div class="list-group-item">
                      <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1"><%= user.username %></h6>
                        <small class="text-muted"><%= new Date(user.created_at).toLocaleDateString() %></small>
                      </div>
                      <p class="mb-1"><%= user.email %></p>
                    </div>
                  <% }); %>
                </div>
              <% } else { %>
                <p class="text-muted">No users found.</p>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Pending Posts -->
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title">Pending Approval</h5>
            </div>
            <div class="card-body">
              <% if (pendingPosts.length > 0) { %>
                <div class="list-group">
                  <% pendingPosts.forEach(post => { %>
                    <div class="list-group-item">
                      <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1"><%= post.title %></h6>
                        <small class="text-muted"><%= new Date(post.created_at).toLocaleDateString() %></small>
                      </div>
                      <p class="mb-1">By: <%= post.username %></p>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-success approve-btn" data-id="<%= post.post_id %>">Approve</button>
                        <button class="btn btn-danger delete-btn" data-id="<%= post.post_id %>">Delete</button>
                      </div>
                    </div>
                  <% }); %>
                </div>
              <% } else { %>
                <p class="text-muted">No posts pending approval.</p>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
  // Post moderation functionality
  document.querySelectorAll('.approve-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const postId = this.dataset.id;
      try {
        const response = await fetch(`/admin/posts/${postId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();
        if (result.success) {
          this.closest('.list-group-item').remove();
        }
      } catch (error) {
        console.error('Error:', error);
      }
    });
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const postId = this.dataset.id;
      if (confirm('Are you sure you want to delete this post?')) {
        try {
          const response = await fetch(`/admin/posts/${postId}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const result = await response.json();
          if (result.success) {
            this.closest('.list-group-item').remove();
          }
        } catch (error) {
          console.error('Error:', error);
        }
      }
    });
  });
</script>

<%- include('../partials/footer') %>