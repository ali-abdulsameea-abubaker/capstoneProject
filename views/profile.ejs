<%- include('partials/header', {title: 'My Profile - Pet Care' }) %>

  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card card-custom">
        <div class="card-body p-4">
          <h1 class="h3 mb-4 text-center">My Profile</h1>

          <% if (typeof message !=='undefined' && message) { %>
            <div class="alert alert-info alert-dismissible fade show">
              <%= message %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <% } %>

              <% if (typeof error !=='undefined' && error) { %>
                <div class="alert alert-danger alert-dismissible fade show">
                  <%= error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <% } %>

                  <div class="text-center mb-4">
                    <div class="position-relative d-inline-block">
                      <img id="profilePicture" src="<%= user.profile_picture_url || '/images/default-avatar.png' %>"
                        class="rounded-circle shadow" width="150" height="150"
                        style="object-fit: cover; transition: opacity 0.3s;"
                        onerror="this.onerror=null; this.src='/images/default-avatar.png'" alt="Profile Picture">
                      <label for="profilePictureInput"
                        class="btn btn-primary rounded-circle position-absolute bottom-0 end-0"
                        style="cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-camera"></i>
                      </label>
                      <% if (user.profile_picture_url) { %>
                        <button class="btn btn-danger rounded-circle position-absolute top-0 end-0"
                          onclick="removeProfilePicture()" title="Remove profile picture"
                          style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center;">
                          <i class="bi bi-trash"></i>
                        </button>
                        <% } %>
                    </div>

                    <!-- Single file input - moved outside the label -->
                    <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">

                    <div class="mt-3">
                      <h4>
                        <%= user.username %>
                      </h4>
                      <p class="text-muted">
                        <%= user.email %>
                      </p>
                    </div>
                  </div>

                  <!-- Stats Overview -->
                  <div class="row mb-4">
                    <div class="col-md-4 mb-3">
                      <div class="card h-100">
                        <div class="card-body text-center p-3 d-flex flex-column justify-content-center">
                          <h6 class="card-title text-muted small">Pets</h6>
                          <p class="card-text h4 mb-0 fw-bold">
                            <%= user.pet_count || 0 %>
                          </p>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4 mb-3">
                      <div class="card h-100">
                        <div class="card-body text-center p-3 d-flex flex-column justify-content-center">
                          <h6 class="card-title text-muted small">Upcoming Tasks</h6>
                          <p class="card-text h4 mb-0 fw-bold">
                            <%= user.upcoming_task_count || 0 %>
                          </p>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4 mb-3">
                      <div class="card h-100">
                        <div class="card-body text-center p-3 d-flex flex-column justify-content-center">
                          <h6 class="card-title text-muted small">Member Since</h6>
                          <p class="card-text h6 mb-0">
                            <%= new Date(user.created_at).toLocaleDateString() %>
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-12 mb-3">
                    <div class="card">
                      <div class="card-body text-center">
                        <h5 class="card-title">Account Type</h5>
                        <p class="card-text">
                          <span class="badge bg-<%= user.role === 'admin' ? 'danger' : 'primary' %>">
                            <%= user.role %>
                          </span>
                        </p>
                      </div>
                    </div>
                  </div>
        </div>

        <div class="text-center mt-4">
          <a href="/dashboard" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
          </a>
          <button class="btn btn-outline-primary ms-2" onclick="testUpload()">
            <i class="bi bi-bug"></i> Test Upload
          </button>
        </div>
      </div>
    </div>
  </div>
  </div>

  <script>
    // Enhanced profile picture handling
    document.addEventListener('DOMContentLoaded', function () {
      console.log('Profile page loaded');

      const fileInput = document.getElementById('profilePictureInput');
      const profileImg = document.getElementById('profilePicture');
      const cameraLabel = document.querySelector('label[for="profilePictureInput"]');

      if (!fileInput) {
        console.error('❌ File input not found!');
        return;
      }

      if (!cameraLabel) {
        console.error('❌ Camera label not found!');
        return;
      }

      // Add click handler to the camera button
      cameraLabel.addEventListener('click', function (e) {
        e.preventDefault();
        console.log('Camera button clicked');
        fileInput.click();
      });

      // Enhanced file input change handler
      fileInput.addEventListener('change', function (e) {
        console.log('File input changed');
        if (this.files && this.files[0]) {
          console.log('File selected:', this.files[0].name, this.files[0].size, 'bytes');
          uploadProfilePicture(this.files[0]);
        } else {
          console.log('No file selected');
        }
      });

      console.log('Event listeners attached successfully');
    });

    async function uploadProfilePicture(file) {
      if (!file) {
        console.log('No file provided');
        return;
      }

      console.log('Starting upload for:', file.name);

      // Show loading state
      const profileImg = document.getElementById('profilePicture');
      const originalOpacity = profileImg.style.opacity;
      profileImg.style.opacity = '0.5';
      profileImg.style.filter = 'grayscale(50%)';

      const formData = new FormData();
      formData.append('profilePicture', file);

      try {
        console.log('Uploading to /profile/picture...');

        const response = await fetch('/profile/picture', {
          method: 'POST',
          body: formData
        });

        console.log('Response received:', response.status);

        const result = await response.json();
        console.log('Upload response:', result);

        if (result.success) {
          console.log('✅ Upload successful');

          // Update profile picture immediately with cache busting
          const profileImg = document.getElementById('profilePicture');
          profileImg.src = result.imageUrl + '?t=' + Date.now();
          profileImg.style.opacity = '1';
          profileImg.style.filter = 'none';

          // Update session data in the header
          updateHeaderProfilePicture(result.imageUrl);

          // Show success message
          showAlert('Profile picture updated successfully!', 'success');

          // Show remove button if it wasn't there
          const removeBtn = document.querySelector('.btn-danger');
          if (!removeBtn) {
            console.log('Reloading page to show remove button...');
            // Reload to show remove button and update everywhere
            setTimeout(() => location.reload(), 1000);
          }

        } else {
          console.error('❌ Upload failed:', result.error);
          showAlert(result.error || 'Error uploading picture', 'danger');
          profileImg.style.opacity = originalOpacity;
          profileImg.style.filter = 'none';
        }
      } catch (error) {
        console.error('❌ Upload error:', error);
        showAlert('Error uploading profile picture: ' + error.message, 'danger');
        profileImg.style.opacity = originalOpacity;
        profileImg.style.filter = 'none';
      } finally {
        // Always reset the file input
        document.getElementById('profilePictureInput').value = '';
        console.log('File input reset');
      }
    }

    function updateHeaderProfilePicture(url) {
      console.log('Updating header images with:', url);
      // Update all profile pictures in the header
      const headerImages = document.querySelectorAll('.navbar img');
      headerImages.forEach(img => {
        if (img.src.includes('profile') || img.alt.includes('Profile')) {
          img.src = url + '?t=' + Date.now();
          console.log('Updated header image:', img);
        }
      });
    }

    async function removeProfilePicture() {
      if (!confirm('Are you sure you want to remove your profile picture?')) {
        return;
      }

      console.log('Removing profile picture...');

      try {
        const response = await fetch('/profile/picture', {
          method: 'DELETE'
        });

        const result = await response.json();
        console.log('Delete response:', result);

        if (result.success) {
          console.log('✅ Removal successful');

          // Reset to default avatar
          const profileImg = document.getElementById('profilePicture');
          profileImg.src = '/images/default-avatar.png?t=' + Date.now();

          // Update header images too
          updateHeaderProfilePicture('/images/default-avatar.png');

          // Hide remove button
          const removeBtn = document.querySelector('.btn-danger');
          if (removeBtn) {
            removeBtn.style.display = 'none';
          }

          showAlert('Profile picture removed successfully!', 'success');
        } else {
          console.error('❌ Removal failed:', result.error);
          showAlert(result.error || 'Error removing picture', 'danger');
        }
      } catch (error) {
        console.error('❌ Delete error:', error);
        showAlert('Error removing profile picture: ' + error.message, 'danger');
      }
    }

    function showAlert(message, type) {
      console.log('Showing alert:', type, message);

      // Remove existing alerts
      const existingAlerts = document.querySelectorAll('.alert');
      existingAlerts.forEach(alert => alert.remove());

      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
      <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

      const cardBody = document.querySelector('.card-body');
      if (cardBody) {
        cardBody.insertBefore(alertDiv, cardBody.firstChild);

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.remove();
          }
        }, 5000);
      }
    }

    // Debug function to test upload
    function testUpload() {
      console.log('=== UPLOAD DEBUG INFO ===');
      console.log('File input:', document.getElementById('profilePictureInput'));
      console.log('Profile image:', document.getElementById('profilePicture'));
      console.log('Session userId:', '<%= userId %>');

      // Create a test file input click
      document.getElementById('profilePictureInput').click();
    }

    // Add global error handler
    window.addEventListener('error', function (e) {
      console.error('Global error:', e.error);
      showAlert('An error occurred: ' + e.error.message, 'danger');
    });
  </script>

  <%- include('partials/footer') %>